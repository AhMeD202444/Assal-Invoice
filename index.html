<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ASSAL OFFICE • Invoices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- أيقونات -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- خطوط (Cairo للعربي + Poppins للإنكليزي) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- XLSX + jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  
 

  
  

  <style>
  
  
  
  
  
  /* Confirm Modal */
.auth-overlay{
  position: fixed; inset: 0; z-index: 9999;
  display: none;              /* نخليها مخفية، نعرضها بالـ JS */
  align-items: center; justify-content: center;
  background: rgba(10,11,14,.55);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.auth-card{
  width: min(420px, 92%);
  background: rgba(20,24,33,.92);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 18px;
  box-shadow: 0 18px 50px rgba(0,0,0,.45);
  padding: 22px 18px;
  color: #eaf0ff;
}





/* ===== Unified System Modal (maintenance / reload) ===== */
.sys-overlay{
  position: fixed; inset: 0; z-index: 9999;
  display: none; align-items: center; justify-content: center;
  background: rgba(10,11,14,.55);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  animation: sysFade .25s ease forwards;
}
@keyframes sysFade { from{opacity:0} to{opacity:1} }

.sys-card{
  width: min(460px, 92%); text-align: center; color: #eaf0ff;
  background: rgba(20,24,33,.92);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 18px; box-shadow: 0 18px 50px rgba(0,0,0,.45);
  padding: 22px 18px; transform: translateY(8px);
  animation: sysPop .25s ease forwards;
}
@keyframes sysPop { to{ transform: translateY(0) } }

.sys-icon-wrap{
  width: 64px; height: 64px; margin: 4px auto 12px;
  display:grid; place-items:center; border-radius: 50%;
  background: radial-gradient(120% 120% at 20% 20%, var(--brand-2), var(--brand-1));
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.sys-spinner{
  width: 28px; height: 28px; border-radius: 50%;
  border: 3px solid rgba(255,255,255,.25);
  border-top-color: #0b0d13;
  animation: spin .8s linear infinite;
}
@keyframes spin { to{ transform: rotate(360deg) } }

.sys-title{ margin:8px 0 4px; font-size:18px; font-weight:800; letter-spacing:.2px; }
.sys-sub{ margin:0 0 12px; color: var(--muted); font-size:13px; }

.sys-progress{
  height: 8px; border-radius: 999px; overflow: hidden;
  background: rgba(255,255,255,.08);
  border: 1px solid var(--stroke);
}
.sys-bar{
  height: 100%;
  background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
  width: 0%; transition: width .2s ease;
}
.sys-count{
  margin-top: 10px; color:#cbd5e1; font-weight:700; font-size:12px;
}


  

  
 
  
  
    :root{
  --bg-1:#0e0f13;
  --bg-2:#0a0b0e;
  --glass: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.14);
  --text:#f5f7ff;
  --muted:#aab0c0;
  --brand-1:#6d5efc;
  --brand-2:#21d4fd;
  --good:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 18px;
  --blur: 14px;
  --speed: .32s;
}

*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: "Cairo","Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
  color: var(--text);
  background:
    radial-gradient(1200px 1200px at 120% -20%, rgba(33,212,253,.20), transparent 60%),
    radial-gradient(900px 900px at -10% 120%, rgba(109,94,252,.20), transparent 60%),
    linear-gradient(180deg, var(--bg-1), var(--bg-2));
  overflow-x:hidden;
}

/* ====== Header ====== */
.app-header{
  position:sticky; top:0; z-index:50;
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  background: linear-gradient( to bottom, rgba(10,11,14,.75), rgba(10,11,14,.35) );
  border-bottom: 1px solid var(--stroke);
}
.head-wrap{
  max-width:1200px; margin:auto; padding:14px 18px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.brand{
  display:flex; align-items:center; gap:12px;
  font-weight:700; letter-spacing:.3px;
}
.brand .badge{
  width:40px; height:40px; display:grid; place-items:center;
  background: radial-gradient(120% 120% at 20% 20%, var(--brand-2), var(--brand-1));
  border-radius:12px; color:#0b0d13; font-weight:900;
  box-shadow: var(--shadow);
}
.brand small{ color: var(--muted); font-weight:600; display:block; margin-top:-2px; font-size:12px; }
.head-actions{ display:flex; align-items:center; gap:10px; }
.icon-btn{
  width:40px; height:40px; display:grid; place-items:center;
  border:1px solid var(--stroke);
  background: var(--glass);
  border-radius:12px; color:var(--text);
  cursor:pointer; transition: transform var(--speed), background var(--speed), border-color var(--speed);
}
.icon-btn:hover{ transform: translateY(-2px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.25); }

/* ====== Layout ====== */
.layout{
  max-width:1200px; margin:22px auto; padding:0 16px;
  display:grid; grid-template-columns: 280px 1fr; gap:16px;
}

/* ===== تخطيط الشبكة: جانبين فوق بعض ومحتوى على اليمين ===== */
.layout{
  display: grid;
  grid-template-columns: 280px 1fr;
  grid-auto-rows: min-content;         /* ارتفاع الصفوف حسب المحتوى */
}

/* تموضع العناصر على الشاشات الكبيرة */
#sidebar{
  grid-column: 1;  /* العمود الأيسر */
  grid-row: 1;     /* الصف الأول */
}
#importedSidebar{
  grid-column: 1;  /* نفس العمود الأيسر */
  grid-row: 2;     /* ينزل تحت الفواتير السابقة */
}
.content{
  grid-column: 2;        /* العمود الأيمن */
  grid-row: 1 / span 2;  /* يمتد على صفّين */
}

/* على 992px وأصغر: نرجّع كلشي عمود واحد (مثل ما عندك) */
@media (max-width: 992px){
  .layout{
    grid-template-columns: 1fr;
    grid-auto-rows: initial;
  }
  #sidebar, #importedSidebar, .content{
    grid-column: auto;
    grid-row: auto;
  }
}


/* تابلت */
@media (max-width: 992px){
  .layout{ grid-template-columns: 1fr; }
}

/* موبايل */
@media (max-width: 576px){
  .layout{
    display: flex;             /* بدل Grid حتى نستخدم order */
    flex-direction: column;
    padding: 0 10px;
    margin: 14px auto;
  }
  .content { order: 1; }
  .sidebar { order: 2; }
}


@media (max-width: 768px){
  .editor > div{
    flex-direction: column;    /* أي سطر داخله display:flex (مثل العدد+الملاحظات/الأزرار) يصير عمودي */
  }
  .editor .ginput{ flex: 1 1 100%; }
}



/* ====== Sidebar ====== */
.sidebar{
  background: var(--glass);
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:14px;
  position:relative;
  overflow:hidden;
}
.panel-title{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:8px 6px 12px; border-bottom:1px dashed var(--stroke);
  margin-bottom:10px;
}
.panel-title h3{ margin:0; font-size:16px; font-weight:800; letter-spacing:.2px; }
.pill{
  background: rgba(255,255,255,.08);
  border:1px solid var(--stroke);
  padding:6px 10px; border-radius:999px; color: var(--muted); font-size:12px;
}

/* Category select */
.category{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.cat-label{ font-size:12px; color:var(--muted); padding:0 6px; }
.cat-select{ position:relative; user-select:none; }
.cat-btn{
  width:100%;
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:12px 14px; cursor:pointer;
  transition: background var(--speed), border-color var(--speed), transform var(--speed);
}
.cat-btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.25); transform: translateY(-1px); }
.cat-list{
  position:absolute; inset-inline:0; top: calc(100% + 8px); z-index:5;
  background: rgba(16,18,24,.98);
  border:1px solid var(--stroke);
  border-radius:16px;
  box-shadow: var(--shadow);
  padding:6px;
  display:none;
  max-height: 280px; overflow:auto;
}
.cat-item{
  padding:10px 12px; border-radius:10px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  color:var(--text); font-weight:600;
  transition: background var(--speed), transform var(--speed);
  border-bottom: 1px dashed rgba(255,255,255,.08);
  text-align:center;
}
.cat-item:last-child{ border-bottom:none; }
.cat-item:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
.cat-item i{ color: var(--brand-2); }

/* Invoices list */
.invoices-list{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
.invoice-chip{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  background: rgba(255,255,255,.05);
  border:1px solid var(--stroke);
  padding:10px 12px; border-radius:12px; cursor:pointer;
  transition: background var(--speed), transform var(--speed);
}
.invoice-chip:hover{ background: rgba(255,255,255,.09); transform: translateY(-1px); }
.chip-meta{ display:flex; flex-direction:column; gap:4px; }
.chip-meta strong{ font-size:13px; }
.chip-meta small{ color:var(--muted); }

/* ====== Content ====== */
.content{ display:flex; flex-direction:column; gap:18px; }

/* Grid cards */
.grid{
  display:grid; grid-template-columns: repeat(3,1fr); gap:14px;
}
@media (max-width: 992px){
  .grid{ grid-template-columns: repeat(2,1fr); }
}
@media (max-width: 576px){
  .editor .ginput {
    flex: 1 1 100%;
  }
  .editor > div {
    flex-direction: column;
  }
  .gfield, .btn {
    font-size:14px;
    padding:10px 12px;
  }
}

.card{
  background: var(--glass);
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:16px;
  overflow:hidden;
  position:relative;
}
.card .title{ display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px; margin-bottom:8px; }
.value{ font-weight:900; font-size:22px; letter-spacing:.3px; display:flex; align-items:center; gap:8px; }
.trend{ font-size:12px; color: var(--good); }

/* Editor */
.editor{ display: flex; flex-direction: column; gap: 12px; }
#searchInput { width: 100%; }
.card.table-wrap { margin-top: 20px; }

/* Footer */
.app-footer {
  position: sticky; bottom: 0; z-index: 50;
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  background: linear-gradient(to top, rgba(10,11,14,.85), rgba(10,11,14,.35));
  border-top: 1px solid var(--stroke);
}
.foot-wrap {
  max-width: 1200px;
  margin: auto;
  padding: 12px 18px;
  text-align: center;
  font-size: 13px;
  color: var(--muted);
}

/* Inputs and buttons */
.ginput{ display:flex; flex-direction:column; gap:8px; }
.glabel{ font-size:12px; color:var(--muted); padding:0 6px; }
.gfield{
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  padding:12px 14px; border-radius:14px; color: var(--text);
  outline:none; transition: border-color var(--speed), background var(--speed), transform var(--speed);
  text-align:center;
  width:100%; max-width:100%;
}
.gfield::placeholder{ color: #93a0b8; }
.gfield:focus{ border-color: rgba(255,255,255,.35); background: rgba(255,255,255,.09); transform: translateY(-1px); }

.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:12px 14px; border:none; cursor:pointer; font-weight:800; letter-spacing:.3px;
  border-radius:14px; color:#0b0d13;
  background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
  box-shadow: 0 8px 20px rgba(109,94,252,.35);
  transition: transform var(--speed), box-shadow var(--speed), filter var(--speed);
  width:100%; max-width:100%;
}
.btn:hover{ transform: translateY(-2px); filter: brightness(1.05); box-shadow: 0 10px 26px rgba(109,94,252,.45); }
.btn.green{ background:linear-gradient(135deg,#34d399,#10b981); color:#091018; }
.btn.amber{ background:linear-gradient(135deg,#f59e0b,#d97706); color:#0b0d13; }
.btn.blue{ background:linear-gradient(135deg,#60a5fa,#2563eb); color:#0b0d13; }

/* Table */
.table-wrap {
  padding: 0;
  overflow-x: auto;              /* يطلع سكرول إذا الجدول أعرض من الشاشة */
  -webkit-overflow-scrolling: touch; /* سلاسة على iOS */
  border-radius: 14px;

  max-height: 300px;             /* يحدد أقصى ارتفاع (تقديراً 5 صفوف) */
  overflow-y: auto;              /* يخلي سكرول عمودي إذا تعدى 5 صفوف */
}


table{
  width: 100%;
  min-width: 680px;            /* نخلي الجدول أكبر شوية حتى يطلع Scroll بالموبايل */
  border-collapse: collapse;
  table-layout: fixed;         /* حتى يلفّ النص داخل الخلايا */
  background: rgba(255,255,255,.04);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  overflow: hidden;
}

thead th, tbody td{
  word-break: break-word;      /* يكسر الكلمات الطويلة داخل الخلية */
  text-align: center;
  padding: 14px;
}

tbody tr:last-child td{ border-bottom:none; }



.btn-danger-custom {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  color: #fff;
  background: linear-gradient(45deg,#ef4444,#dc2626);
  border: none;
  cursor: pointer;
  transition: transform .2s, background .2s;
}
.btn-danger-custom:hover {
  background: linear-gradient(45deg,#dc2626,#b91c1c);
  transform: translateY(-2px);
}


#itemsTable td:last-child {
  text-align: center;
  vertical-align: middle;
}




/* ====== تنسيق الجدول داخل الواجهة ====== */
table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--stroke);   /* حدود خارجية */
  border-radius: 14px;
  overflow: hidden;
}

/* رأس الجدول */
thead th {
  background: linear-gradient(135deg, #1e293b, #0f172a); /* تدرج داكن أنيق (كحلي/أسود مزرق) */
  color: #f1f5f9;                          /* نص فاتح جداً (رمادي مائل للأبيض) */
  font-weight: 700;                        /* خط عريض */
  padding: 14px;
  border: 1px solid rgba(255,255,255,.08); /* حدود ناعمة جداً */
  text-align: center;
  letter-spacing: .5px;                    /* مسافة بسيطة بين الحروف */
  font-size: 15px;
  text-transform: none;                    /* نخلي النص طبيعي بدون أحرف كبيرة */
  box-shadow: inset 0 -1px 6px rgba(0,0,0,.4); /* ظل داخلي غامق يضيف عمق */
}


/* الخلايا */
tbody td {
  padding: 12px;
  border: 1px solid #cbd5e1;  /* خطوط ناعمة بين الخلايا */
  text-align: center;
  font-size: 14px;
  color: #0f172a;             /* نص داكن واضح */
}




#itemsTable .btn-danger-custom {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
}






/* تلوين الصفوف بالتناوب */
/* صفوف الجدول */
tbody tr:nth-child(even) {
  background-color: #f8fafc;  /* لون فاتح للصفوف الزوجية */
}
tbody tr:nth-child(odd) {
  background-color: #e2e8f0;  /* لون أغمق شوي للصفوف الفردية */
}

/* عند المرور بالماوس */
tbody tr:hover {
  background: rgba(33,212,253,.15);  /* هايلايت أنيق */
  transition: background 0.3s ease;
}




/* Floating button */
.fab{
  position:fixed; inset-inline-start:20px; inset-block-end:20px; z-index:60;
  width:58px; height:58px; display:grid; place-items:center; border-radius:50%;
  background: conic-gradient(from 180deg at 50% 50%, var(--brand-2), var(--brand-1), var(--brand-2));
  color:#0b0d13; font-size:20px; font-weight:900;
  box-shadow: 0 14px 35px rgba(100,95,255,.45);
  cursor:pointer; transition: transform var(--speed);
}
.fab:hover{ transform: translateY(-3px) rotate(-2deg); }

/* Toast */
.toast-container{ position: fixed; inset-block-start:18px; inset-inline:0; display:grid; place-items:center; z-index:70; }
.toast{
  background: rgba(20,24,33,.96);
  border: 1px solid var(--stroke);
  color: var(--text);
  padding:12px 16px; border-radius:12px; box-shadow: var(--shadow);
  display:none; align-items:center; gap:10px; font-weight:700;
}
.toast.show{ display:flex; animation: pop .3s ease; }
@keyframes pop{ from{ transform: translateY(-8px); opacity:.0; } to{ transform: translateY(0); opacity:1; } }

/* Search suggestions */
#autocompleteSuggestions{
  position: absolute; inset-inline:0; inset-block-start:100%; margin-block-start:6px;
  background: rgba(16,18,24,.98);
  border:1px solid var(--stroke);
  border-radius:14px;
  max-height:240px; overflow:auto; z-index:40; display:none;
}
#autocompleteSuggestions li{
  list-style:none; padding:10px 12px; cursor:pointer; text-align:center; color:#eaf0ff;
  border-bottom:1px dashed rgba(255,255,255,.08);
}
#autocompleteSuggestions li:last-child{ border-bottom:none; }
#autocompleteSuggestions li:hover{ background: rgba(255,255,255,.06); }

/* Responsive header + footer for small screens */
@media (max-width:576px){
  .brand .badge{ width:32px; height:32px; font-size:14px; }
  .head-actions .icon-btn{ width:34px; height:34px; }
  .head-wrap, .foot-wrap{ padding:10px 12px; }
}



/* صفين متساويين دائماً: العدد+الملاحظات، حفظ+PDF */
.line-qty-note,
.line-actions{
  display: grid;
  grid-template-columns: 1fr 1fr; /* تساوي العرض */
  gap: 12px;
  align-items: stretch;
}

.line-qty-note .ginput,
.line-actions .btn{
  min-width: 0; /* يمنع البروز/التمدد الزائد */
}

/* لو عندك قواعد قديمة تقلب أسطر .editor لعمودي بالموبايل،
   هذا الكود ما يتأثر لأننا Grid، و flex-direction ما ينطبق على grid */
   
   
   
   
   /* ===== Maintenance Overlay ===== */
.maint-overlay{
  position: fixed; inset: 0; z-index: 10000;
  display: none;                    /* نظهرها بالـ JS */
  align-items: center; justify-content: center;
  background: rgba(10,11,14,.55);
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
}
.maint-card{
  width: min(520px, 92%);
  background: linear-gradient(180deg, rgba(20,24,33,.96), rgba(13,16,22,.96));
  border: 1px solid var(--stroke);
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
  padding: 28px 22px;
  text-align: center;
  color: var(--text);
}
.maint-card h2{
  margin: 6px 0 6px; font-size: 22px; font-weight: 800; letter-spacing: .2px;
}
.maint-card p{
  margin: 0; color: var(--muted); font-size: 14px;
}
.maint-spin{
  width: 58px; height: 58px; margin: 0 auto 12px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,.18);
  border-top: 4px solid var(--brand-2);
  animation: maint-rot 1s linear infinite;
  box-shadow: 0 0 0 4px rgba(33,212,253,.06), 0 10px 24px rgba(0,0,0,.25);
}
@keyframes maint-rot { to { transform: rotate(360deg); } }





  </style>
</head>
<body>
  
  
  
  
  
  <div id="maintenanceOverlay" class="maint-overlay" style="display:none;">
  <div class="maint-card">
    <div class="maint-spin"></div>
    <h2>التطبيق تحت الصيانة</h2>
    <p>نرجعلك حالاً.. شكراً لصبرك 💙</p>
  </div>
</div>
  
  
  
 <!-- نافذة النظام الموحّدة (صيانة/تحديث/معلومات) -->
<div id="systemModal" class="sys-overlay" aria-hidden="true">
  <div class="sys-card" role="dialog" aria-modal="true" aria-live="polite">
    <div class="sys-icon-wrap">
      <div class="sys-spinner"></div>
    </div>
    <h3 class="sys-title" id="sysTitle">جاري تحديث التطبيق</h3>
    <p class="sys-sub"   id="sysSub">نحضّر لك كل شيء…</p>

    <!-- عدّاد + شريط تقدّم اختياريان -->
    <div class="sys-progress" id="sysProgress" hidden>
      <div class="sys-bar" id="sysBar" style="width:0%"></div>
    </div>
    <div class="sys-count" id="sysCount" hidden>3</div>
  </div>
</div>

  

  <!-- ====== Header ====== -->
  <header class="app-header">
    <div class="head-wrap">
      <div class="brand">
  <div class="badge">A</div>
  <span style="font-weight:700; font-size:18px;">ASSAL OFFICE</span>
</div>

      <div class="head-actions">
  <button class="icon-btn" id="btnNew" title="فاتورة جديدة"><i class="fa-solid fa-plus"></i></button>
  <button class="icon-btn" id="btnReload" title="تحديث الصفحة"><i class="fa-solid fa-rotate-right"></i></button>

  <!-- زر تصدير JSON فقط -->
 <button class="icon-btn" id="btnExportJSON" title="تصدير Excel">
  <i class="fa-solid fa-file-excel"></i>
  </button>
  
  
  <button class="icon-btn" id="btnExportCSV" title="تصدير CSV">
  <i class="fa-solid fa-file-csv"></i>
</button>


</div>


    </div>
  </header>
  
  
  
  
  <!-- نافذة تأكيد تعديل المادة -->
<div id="confirmModal" class="auth-overlay">
  <div class="auth-card" style="text-align:center;">
    <h3 style="margin:0 0 6px 0;">المادة موجودة بالفعل</h3>
    <p style="margin:0 0 14px 0; color:#aab0c0;">هل تريد تعديل العدد والملاحظات؟</p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="confirmYes" class="btn green"><i class="fa-solid fa-check"></i> نعم</button>
      <button id="confirmNo" class="btn amber"><i class="fa-solid fa-xmark"></i> لا</button>
    </div>
  </div>
</div>




<!-- نافذة تأكيد حذف الفاتورة -->
<div id="deleteInvoiceModal" class="auth-overlay" aria-hidden="true">
  <div class="auth-card" role="dialog" aria-modal="true" style="text-align:center;">
    <h3 style="margin:0 0 6px 0;">حذف الفاتورة؟</h3>
    <p style="margin:0 0 14px 0; color:#aab0c0;">سيتم حذف الفاتورة نهائياً من الجهاز.</p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="delInvYes" class="btn green"><i class="fa-solid fa-check"></i> نعم</button>
      <button id="delInvNo"  class="btn amber"><i class="fa-solid fa-xmark"></i> لا</button>
    </div>
  </div>
</div>


  
  
  
  
  

  <!-- ====== Layout ====== -->
  <main class="layout">

    <!-- ====== Sidebar ====== -->
    <aside class="sidebar" id="sidebar">
      <div class="panel-title">
        <h3><i class="fa-regular fa-folder-open"></i> الفواتير السابقة</h3>
        <span class="pill">اليوم</span>
      </div>

    

      <!-- لائحة الفواتير السابقة (نفس الـ id القديم لكن داخل الشريط) -->
      <div class="invoices-list" id="invoicesDropdown"></div>
    </aside>
    
    
    
        <!-- ====== Sidebar مستقل (الفواتير المستوردة PDF) ====== -->
    <aside class="sidebar" id="importedSidebar">
      <div class="panel-title">
   <h3><i class="fa-solid fa-file-import"></i> الفواتير المستوردة (Excel/CSV)</h3>
        <div style="display:flex; gap:8px;">
      <button class="icon-btn" id="btnImportPDF" title="استيراد JSON">

            <i class="fa-solid fa-download"></i>
          </button>
          <button class="icon-btn" id="btnMergePDF" title="دمج (وترتيب الأيتمات)">
            <i class="fa-solid fa-layer-group"></i>
          </button>
        </div>
      </div>

      <div id="importedPdfList" class="invoices-list"></div>
     <input id="pdfFilePicker" type="file"
  accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.csv,text/csv"
  multiple style="display:none;">

    </aside>

    
    
    
    

    <!-- ====== Content ====== -->
    <section class="content">


      <!-- بطاقة معلومات الفاتورة الحالية -->
      <div class="card" style="display:flex; align-items:center; gap:12px;">
        <i class="fa-regular fa-file-lines" style="font-size:28px; color:#21d4fd;"></i>
        <div>
          <div style="font-weight:800; letter-spacing:.2px;">فاتورة حالية</div>
          <div style="color:var(--muted); font-size:12px;">رقم الفاتورة: <span id="invoiceId">-</span></div>
        </div>
      </div>

      <!-- محرر الفاتورة -->
      <div class="card">
        <div class="title"><span><i class="fa-solid fa-pen-to-square"></i> إضافة مادة</span><span class="muted">Editor</span></div>

       <div class="editor">

  <!-- الصنف -->
  <div class="category">
    <!-- زر فتح القائمة -->
    <div class="cat-select" id="catSelect">
      <div class="cat-btn" id="catBtn">
        <span id="catText"><i class="fa-solid fa-layer-group"></i> اختر الصنف</span>
        <i class="fa-solid fa-chevron-down"></i>
      </div>

      <!-- قائمة الأصناف -->
      <div class="cat-list" id="catList">
        <div class="cat-item" data-val="LCD"><i class="fa-solid fa-tv"></i> شاشات</div>
        <div class="cat-item" data-val="BATTERY"><i class="fa-solid fa-bolt"></i> بطاريات</div>
        <div class="cat-item" data-val="CAMERA"><i class="fa-solid fa-camera"></i> كاميرات</div>
        <div class="cat-item" data-val="CHARGING"><i class="fa-solid fa-plug"></i> شحن</div>
        <div class="cat-item" data-val="HEADPHONE"><i class="fa-solid fa-headphones"></i> سماعة</div>
        <div class="cat-item" data-val="HOUSING"><i class="fa-solid fa-border-none"></i> شواصي</div>
        <div class="cat-item" data-val="BACK"><i class="fa-solid fa-mobile-screen"></i> أظهر</div>
        <div class="cat-item" data-val="BUZZER"><i class="fa-solid fa-bell"></i> جرس</div>
        <div class="cat-item" data-val="FINGER"><i class="fa-solid fa-fingerprint"></i> بصمة</div>
        <div class="cat-item" data-val="NO-CATEGORY"><i class="fa-regular fa-square"></i> بدون صنف</div>
      </div>
    </div>

    <!-- الحقل المخفي -->
    <input id="categorySelect" type="hidden" />
  </div>

  <!-- اسم القطعة -->
  <div class="ginput">
    <div style="position:relative;">
      
      
   <input id="searchInput" class="gfield" type="text" placeholder="اكتب اسم القطعة..." 
       lang="en" style="ime-mode:disabled;" oninput="showSuggestions()" />
     
     
     
      <ul id="autocompleteSuggestions"></ul>
    </div>
  </div>

  <!-- العدد + الملاحظات بنفس الصف ومتساوي -->
<div class="line-qty-note">
  <div class="ginput">
    <input id="itemQty" class="gfield" type="text" placeholder="عدد القطع" />
  </div>
  <div class="ginput">
    <input id="itemNote" class="gfield" type="text" placeholder="ملاحظات" />
  </div>
</div>


  <!-- زر الإضافة لوحده -->
<div class="ginput">
  <button id="btnAddItem" class="btn" type="button" onclick="addItem()">
    <i class="fa-solid fa-plus"></i> إضافة
  </button>
</div>

<!-- حفظ + PDF بنفس الصف ومتساوي -->
<div class="line-actions">
  <button class="btn green" onclick="saveInvoice()">
    <i class="fa-regular fa-floppy-disk"></i> حفظ
  </button>
  <button class="btn blue" onclick="exportPDF()">
    <i class="fa-regular fa-file-pdf"></i> PDF
  </button>
</div>


      <!-- الجدول -->
      <div class="card table-wrap">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>الصنف</th>
              <th>القطعة</th>
              <th>العدد</th>
              <th>ملاحظات</th>
              <th>إزالة</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </section>
  </main>

  <!-- زر عائم = فاتورة جديدة -->
  <button class="fab" id="fab" title="فاتورة جديدة">
    <i class="fa-solid fa-plus"></i>
  </button>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast" id="appToast">
      <i class="fa-solid fa-circle-check" style="color:#34d399;"></i>
      <span>تمت العملية بنجاح.</span>
    </div>
  </div>

  <script>
    /* =========================
       متغيرات عامة (نفس القديمة)
       ========================= */
    let currentInvoice = null;                                             // الفاتورة الحالية
    let invoices = JSON.parse(localStorage.getItem("invoices") || "[]");   // كل الفواتير المخزنة
    let selectedInvoiceIndex = null;                                       // مؤشر الفاتورة المختارة
    let database = {};                                                     // قاعدة بيانات الأصناف من الإكسل
    let currentCategory = "";                                              // الصنف الحالي المختار
    let importedPdfFiles = [];                                             // ملفات PDF المستوردة مؤقتًا

    // رابط ملف الإكسل (نفسك)
    const dropboxMainFile = "https://assap-app-project.ahmed-al-bayatii-90.workers.dev/file1?t=" + new Date().getTime();






// ===== واجهة موحّدة لرسائل النظام (صيانة/تحديث/معلومات) =====
function openSystemModal({title, sub, showProgress=false, seconds=null} = {}){
  const modal = document.getElementById("systemModal");
  const t = document.getElementById("sysTitle");
  const s = document.getElementById("sysSub");
  const p = document.getElementById("sysProgress");
  const b = document.getElementById("sysBar");
  const c = document.getElementById("sysCount");

  t.textContent = title || "رسالة النظام";
  s.textContent = sub   || "";
  p.hidden = !showProgress; b.style.width = "0%";
  c.hidden = (seconds==null);

  if(seconds!=null) c.textContent = seconds;

  modal.style.display = "flex";

  // إرجاع أدوات تحكم
  let tickTimer = null;
  return {
    setProgress: (val)=>{ if(!p.hidden){ b.style.width = `${Math.max(0,Math.min(100,val))}%`; } },
    startCountdown: (sec, onDone)=>{
      if(sec==null) return;
      let left = sec;
      c.hidden = false; c.textContent = left;
      tickTimer = setInterval(()=>{
        left -= 1;
        if(left <= 0){
          clearInterval(tickTimer);
          c.textContent = "0";
          onDone && onDone();
        }else{
          c.textContent = left;
        }
      }, 1000);
    },
    close: ()=>{
      if(tickTimer) clearInterval(tickTimer);
      modal.style.display = "none";
    }
  };
}

// ===== آلية التحديث الجديدة (أجمل + أوضح) =====
function reloadPage(options = {}){
  const {
    seconds = 3,                          // مدة العدّاد
    preTitle = "جاري تحديث التطبيق",      // العنوان الأول
    preSub   = "نحضّر لك كل شيء…",        // الوصف الأول
    postTitle= "تم التحديث ✅",            // العنوان بعد الاكتمال
    postSub  = "سيُعاد فتح الصفحة الآن",  // الوصف بعد الاكتمال
    showBar  = true                       // إظهار شريط تقدّم
  } = options;

  // نعرض النافذة
  const ctl = openSystemModal({
    title: preTitle,
    sub: preSub,
    showProgress: showBar,
    seconds
  });

  // لو مفعّل شريط التقدّم نحركه تدريجياً مع العدّاد
  if(showBar){
    let elapsed = 0;
    const total = seconds * 1000;
    const step = 100; // كل 100ms
    const timer = setInterval(()=>{
      elapsed += step;
      const pct = Math.min(100, Math.floor((elapsed/total)*100));
      ctl.setProgress(pct);
      if(pct >= 100) clearInterval(timer);
    }, step);
  }

  // نبدأ العدّاد؛ وبعده نبدّل النصّ ونحمّل
  ctl.startCountdown(seconds, ()=>{
    // تبديل النص للحظات قبل إعادة التحميل
    document.getElementById("sysTitle").textContent = postTitle;
    document.getElementById("sysSub").textContent   = postSub;

    // فاصلة قصيرة تعطي إحساس انتقال أنيق
    setTimeout(()=>{
      // إعادة التحميل الفعلية
      window.location.reload();
    }, 600);
  });
}

// ===== اربط الزر الموجود عندك بنفس الاسم =====
document.getElementById("btnReload").addEventListener("click", ()=>{
  // تقدر تغيّر الإعدادات هنا بسهولة
  reloadPage({
    seconds: 4,                     // عدّاد 4 ثواني
    preTitle: "جاري تحديث الصفحة",  // نص قبل التحديث
    preSub:   "نحدّث البيانات والواجهات…",
    postTitle:"تم التحديث بنجاح ✅",
    postSub:  "نأخذك لآخر نسخة الآن…",
    showBar:  true
  });
});







    /* =========================
       تحميل جداول الإكسل
       ========================= */
    async function loadExcelFiles(){
      try{
        const response = await fetch(dropboxMainFile, { cache: 'no-store' });
        const buffer = await response.arrayBuffer();
        const workbook = XLSX.read(buffer, { type:"array" });
        database = {
          LCD      : XLSX.utils.sheet_to_json(workbook.Sheets["LCD"]      || {}, {defval:null}),
          BATTERY  : XLSX.utils.sheet_to_json(workbook.Sheets["BATTERY"]  || {}, {defval:null}),
          HOUSING  : XLSX.utils.sheet_to_json(workbook.Sheets["HOUSING"]  || {}, {defval:null}),
          BACK     : XLSX.utils.sheet_to_json(workbook.Sheets["BACK"]     || {}, {defval:null}),
          CAMERA   : XLSX.utils.sheet_to_json(workbook.Sheets["CAMERA"]   || {}, {defval:null}),
          CHARGING : XLSX.utils.sheet_to_json(workbook.Sheets["CHARGING"] || {}, {defval:null}),
          BUZZER   : XLSX.utils.sheet_to_json(workbook.Sheets["BUZZER"]   || {}, {defval:null}),
          HEADPHONE: XLSX.utils.sheet_to_json(workbook.Sheets["HEADPHONE"]|| {}, {defval:null}),
          FINGER   : XLSX.utils.sheet_to_json(workbook.Sheets["FINGER"]   || {}, {defval:null})
        };
      }catch(err){
        console.error("❌ خطأ تحميل:", err);
        showToast("تعذر تحميل البيانات ❌", true);
      }
    }

    /* =========================
       أدوات مساعدة
       ========================= */
    function normalizeString(str){ return (str||"").replace(/\s+/g,'').toLowerCase(); }

    function getDayNameAr(d){
      return ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][d.getDay()];
    }

    function formatInvoiceName(){
      const d = new Date();
      return `فاتورة ${getDayNameAr(d)} - ${d.toLocaleDateString("ar-EG")}`;
    }

    /* =========================
       اقتراحات البحث حسب الصنف
       ========================= */
  function showSuggestions(){
  const q = normalizeString(document.getElementById("searchInput").value.trim());
  const suggestions = document.getElementById("autocompleteSuggestions");
  suggestions.innerHTML = ""; 
  suggestions.style.display = "none";

  if(!q || !document.getElementById("categorySelect").value) return;
  currentCategory = document.getElementById("categorySelect").value;
  if(currentCategory === "NO-CATEGORY") return;

  const list = database[currentCategory] || [];
  const filtered = list.filter(it=>{
    const name = normalizeString(it["Item Name"] || it["Item"] || "");
    return name.includes(q);
  });

  if(filtered.length > 0){
    suggestions.style.display = "block";
    filtered.slice(0,20).forEach(it=>{
      const li = document.createElement("li");
      li.className = "list-group-item list-group-item-action";
      li.textContent = it["Item Name"] || it["Item"];

      // التعديل هنا 👇
      li.addEventListener("click", ()=>{
        document.getElementById("searchInput").value = li.textContent;
        suggestions.style.display = "none";
        document.getElementById("itemQty").focus(); // ينزل مباشرة على العدد
      });

      suggestions.appendChild(li);
    });
  }
}


    /* =========================
       إضافة مادة للفاتورة
       ========================= */
  function addItem(){
  if(!currentInvoice){
    showToast("أنشئ فاتورة جديدة أولاً ❌","danger");
    return;
  }

  const category = document.getElementById("categorySelect").value;
  const name     = document.getElementById("searchInput").value.trim();
  const qty      = document.getElementById("itemQty").value.trim() || "1";
  const note     = document.getElementById("itemNote").value.trim() || "";

  if(!category || !name){
    showToast("أدخل الصنف واسم القطعة ❌","danger");
    return;
  }

  // نعتبرها مكررة إذا نفس الصنف ونفس الاسم
  const existingIndex = (currentInvoice.items || []).findIndex(
    (it) => it.category === category && it.name === name
  );

  if(existingIndex !== -1){
    // افتح نافذة التأكيد
    const modal = document.getElementById("confirmModal");
    modal.style.display = "flex";

    // نعم = عدّل نفس السطر
    document.getElementById("confirmYes").onclick = ()=>{
      currentInvoice.items[existingIndex].qty  = qty;
      currentInvoice.items[existingIndex].note = note;

      renderItems();
      autoSaveInvoice();

      modal.style.display = "none";
      showToast("✏️ تم تعديل المادة وحفظ الفاتورة","info");

      // تفريغ + فوكس
      document.getElementById("searchInput").value="";
      document.getElementById("itemQty").value="";
      document.getElementById("itemNote").value="";
      document.getElementById("searchInput").focus();
    };

    // لا = إغلاق فقط
    document.getElementById("confirmNo").onclick = ()=>{
      modal.style.display = "none";
    };

  } else {
    // مادة جديدة
    if(!Array.isArray(currentInvoice.items)) currentInvoice.items = [];
    currentInvoice.items.push({category,name,qty,note});

    renderItems();
    autoSaveInvoice();

    showToast("تمت إضافة المادة وحفظ الفاتورة ✅","success");

    // تفريغ + فوكس
    document.getElementById("searchInput").value="";
    document.getElementById("itemQty").value="";
    document.getElementById("itemNote").value="";
    document.getElementById("searchInput").focus();
  }
}

    /* =========================
       رسم جدول العناصر
       ========================= */
    function renderItems(){
      const tbody = document.querySelector("#itemsTable tbody");
      tbody.innerHTML = "";
      if(!currentInvoice) return;

      currentInvoice.items.forEach((it, i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.category}</td>
          <td>${it.name}</td>
          <td>${it.qty}</td>
          <td>${it.note}</td>
          <td>
            <button class="btn-danger-custom" title="حذف" onclick="removeItem(${i})">
  <i class="fa-regular fa-trash-can"></i>
</button>

          </td>`;
        tbody.appendChild(tr);
      });
    }

    function removeItem(i){
  currentInvoice.items.splice(i,1);
  renderItems();
  autoSaveInvoice(); // ✅ إضافة
  showToast("تم حذف المادة وحفظ الفاتورة 🗑️");
}


    /* =========================
       إنشاء / حفظ / فتح / حذف فواتير
       ========================= */
    function newInvoice(){
      const today = new Date().toLocaleDateString("ar-EG");
      const existingIndex = invoices.findIndex(inv => inv.date === today);

      if(existingIndex !== -1){
        currentInvoice = invoices[existingIndex];
        selectedInvoiceIndex = existingIndex;
        showToast("فاتورة اليوم موجودة، تم تحميلها ✅");
      } else {
        currentInvoice = { id: formatInvoiceName(), date: today, items: [] };
        invoices.push(currentInvoice);
        selectedInvoiceIndex = invoices.length - 1;
        showToast("تم إنشاء فاتورة جديدة ✅");
      }

      document.getElementById("invoiceId").textContent = currentInvoice.id;
      renderItems();
      renderInvoicesDropdown();
    }
    
    
    
    
    
    // ===== تأكيد حذف الفاتورة =====
let __pendingDeleteInvoiceIndex = null;

function openDeleteInvoiceModal(i, ev){
  if(ev) ev.stopPropagation(); // ما يفتح الفاتورة بالغلط
  __pendingDeleteInvoiceIndex = i;
  const modal = document.getElementById('deleteInvoiceModal');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');

  // ربط الأزرار
  document.getElementById('delInvYes').onclick = confirmDeleteInvoice;
  document.getElementById('delInvNo').onclick  = closeDeleteInvoiceModal;

  // إغلاق عند الضغط خارج الكارد
  modal.addEventListener('click', outsideClickClose);
  // إغلاق بـ Esc
  document.addEventListener('keydown', escClose);
}

function confirmDeleteInvoice(){
  if(__pendingDeleteInvoiceIndex===null) return;
  // الحذف الفعلي
  invoices.splice(__pendingDeleteInvoiceIndex, 1);
  localStorage.setItem("invoices", JSON.stringify(invoices));

  // إعادة تهيئة الحالة
  currentInvoice = null;
  selectedInvoiceIndex = null;
  document.getElementById("invoiceId").textContent = "-";
  renderItems();
  renderInvoicesDropdown();

  closeDeleteInvoiceModal();
  showToast("تم حذف الفاتورة 🗑️");
}

function closeDeleteInvoiceModal(){
  const modal = document.getElementById('deleteInvoiceModal');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
  __pendingDeleteInvoiceIndex = null;

  modal.removeEventListener('click', outsideClickClose);
  document.removeEventListener('keydown', escClose);
}

function outsideClickClose(e){
  const card = e.currentTarget.querySelector('.auth-card');
  if(!card.contains(e.target)) closeDeleteInvoiceModal();
}

function escClose(e){
  if(e.key === 'Escape') closeDeleteInvoiceModal();
}

    
    
    
    
    
    
    
    
    
    

    function saveInvoice(){
      if(!currentInvoice) return;
      if(selectedInvoiceIndex !== null){
        invoices[selectedInvoiceIndex] = currentInvoice;
      } else {
        invoices.push(currentInvoice);
      }
      localStorage.setItem("invoices", JSON.stringify(invoices));
      renderInvoicesDropdown();
      showToast("تم حفظ الفاتورة 💾");
    }
    
    
    
    function autoSaveInvoice(){
  if(!currentInvoice) return;
  if(selectedInvoiceIndex!==null){
    invoices[selectedInvoiceIndex] = currentInvoice;
  } else {
    invoices.push(currentInvoice);
    selectedInvoiceIndex = invoices.length - 1;
  }
  localStorage.setItem("invoices", JSON.stringify(invoices));
  renderInvoicesDropdown();
}

    
    

   function renderInvoicesDropdown(){
  const wrap = document.getElementById("invoicesDropdown");
  wrap.innerHTML = "";
  invoices.forEach((inv, i)=>{
    const row = document.createElement("div");
    row.className = "invoice-chip";
    row.innerHTML = `
      <div class="chip-meta">
        <strong>${inv.id}</strong>
        <small>${inv.date} • ${inv.items.length} مادة</small>
      </div>
      <button class="btn-danger-custom" title="حذف" onclick="openDeleteInvoiceModal(${i}, event)">
        <i class="fa-regular fa-trash-can"></i>
      </button>
    `;
    row.onclick = ()=> loadInvoice(i);
    wrap.appendChild(row);
  });
}


    function loadInvoice(i){
      selectedInvoiceIndex = i;
      currentInvoice = invoices[i];
      document.getElementById("invoiceId").textContent = currentInvoice.id;
      renderItems();
      showToast("تم تحميل الفاتورة 📄");
    }

    function deleteInvoice(i){
      invoices.splice(i,1);
      localStorage.setItem("invoices", JSON.stringify(invoices));
      currentInvoice = null;
      document.getElementById("invoiceId").textContent = "-";
      renderItems();
      selectedInvoiceIndex = null;
      renderInvoicesDropdown();
      showToast("تم حذف الفاتورة 🗑️");
    }
    
    
    
    
    
    
        // ===== قائمة ملفات PDF المستوردة في الـ Aside المستقل =====
   function renderImportedPdfList(){
  const wrap = document.getElementById("importedPdfList");
  wrap.innerHTML = "";
  if(!importedPdfFiles.length){
    const empty = document.createElement("div");
    empty.className = "chip-meta";
    empty.style.color = "var(--muted)";
    empty.style.textAlign = "center";
    empty.textContent = "لا توجد ملفات Excel/CSV مستوردة بعد";
    wrap.appendChild(empty);
    return;
  }
  importedPdfFiles.forEach((f, i)=>{
    const ext = f.name.split(".").pop().toUpperCase();
    const row = document.createElement("div");
    row.className = "invoice-chip";
    row.innerHTML = `
      <div class="chip-meta">
        <strong>${f.name}</strong>
        <small>${Math.round(f.size/1024)}KB • ${ext}</small>
      </div>
      <button class="btn-danger-custom" title="إزالة" onclick="removeImportedPdf(${i})">
        <i class="fa-regular fa-trash-can"></i>
      </button>
    `;
    wrap.appendChild(row);
  });
}


    function removeImportedPdf(i){
      importedPdfFiles.splice(i,1);
      renderImportedPdfList();
      showToast("تم حذف الملف المستورد 🗑️");
    }
    
    
    
    
    
    
   async function exportCSVOnly(){
  if(!currentInvoice || !(currentInvoice.items||[]).length){
    showToast("لا توجد بيانات للتصدير ❌", true);
    return;
  }

  // اسم الملف مثل الباقي
  const d = new Date();
  const invoiceId = `INV-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
  const csvName   = `Invoice_${invoiceId}.csv`;

  // ترتيب مثل PDF/Excel: Category ثم Item
  const sorted = [...(currentInvoice.items||[])].sort((a,b)=>{
    const c = String(a.category||"").localeCompare(String(b.category||""), "en", {sensitivity:"base"});
    return c!==0 ? c : String(a.name||"").localeCompare(String(b.name||""), "en", {sensitivity:"base"});
  });

  // محوّل آمن لقيم CSV (يدعّم الفواصل، علامات اقتباس، والأسطر الجديدة)
  const esc = (val)=>{
    const s = String(val ?? "");
    const needsQuotes = /[",\r\n]/.test(s);
    const doubled = s.replace(/"/g, '""');
    return needsQuotes ? `"${doubled}"` : doubled;
  };

  // الهيدر + الصفوف
  const header = ["Category","Item","Quantity","Notes"];
  const rows = [
    header,
    ...sorted.map(it=>[it.category, it.name, it.qty, it.note])
  ];

  // نص CSV مع BOM علشان العربية تفتح صح بالإكسل
  const csv = "\uFEFF" + rows.map(r => r.map(esc).join(",")).join("\r\n");

  // ننشئ Blob وننزّل بالـ fallback مالتك (بدون data:url)
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  downloadBlobFallback(csvName, blob);

  showToast("✅ تم تصدير CSV");
}





// يحاول يرجّع أسماء أعمدة موحدة من أي ملف (عربي/إنكليزي/أحرف مختلفة)
function pick(r, keys){
  for(const k of keys){
    if(r[k] != null && r[k] !== "") return String(r[k]);
  }
  return "";
}

// تحويل ورقة (Sheet) إلى آيتمات موحدة
function sheetToItems(ws){
  // defval:"" حتى ما تطلع undefined
  const rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });
  const out = [];
  rows.forEach(r=>{
    const category = pick(r, ["category","Category","CATEGORY","الصنف","صنف"]);
    const item     = pick(r, ["item","Item","ITEM","القطعة","قطعة","Item Name","اسم","اسم القطعة"]);
    const qty      = pick(r, ["qty","Qty","QTY","Quantity","العدد","عدد"]);
    const note     = pick(r, ["note","Note","NOTES","Notes","ملاحظات"]);

    if(String(item).trim().length){ // لازم على الأقل اسم القطعة
      out.push({
        category: String(category||"").trim(),
        item    : String(item||"").trim(),
        qty     : String(qty||"").trim(),
        note    : String(note||"").trim()
      });
    }
  });
  return out;
}

// يقرأ ملف واحد (XLSX أو CSV) ويرجّع Array من الآيتمات
async function extractItemsFromFile(file){
  // نستخدم arrayBuffer حتى يشتغل مع كل الأنواع ويأخذ BOM للـ CSV
  const buf = await file.arrayBuffer();
  // SheetJS يميّز CSV/XLSX تلقائياً بالقراءة من الـ buffer
  const wb  = XLSX.read(buf, { type: "array" });
  const items = [];
  (wb.SheetNames || []).forEach(name=>{
    const ws = wb.Sheets[name];
    if(ws) items.push(...sheetToItems(ws));
  });
  return items;
}





  

    /* =========================
       تصدير PDF بشكل أنيق بالإنكليزي
       ========================= */
  async function exportPDF() {
  if (!currentInvoice || (currentInvoice.items || []).length === 0) {
    showToast("No data to export ❌", true);
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

  // ترتيب العناصر (Category ثم Item)
  const sortedItems = [...(currentInvoice.items || [])].sort((a, b) => {
    const catA = String(a.category || "");
    const catB = String(b.category || "");
    const nameA = String(a.name || "");
    const nameB = String(b.name || "");
    const catCompare = catA.localeCompare(catB, "en", { sensitivity: "base" });
    return catCompare !== 0 ? catCompare : nameA.localeCompare(nameB, "en", { sensitivity: "base" });
  });

  const pageWidth  = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  // Header
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.setTextColor(25, 25, 112);
  doc.text("ASSAL OFFICE", pageWidth / 2, 65, { align: "center" });
  doc.setFontSize(12);
  doc.setTextColor(100);
  doc.text("YOUR BEST CHOICE", pageWidth / 2, 85, { align: "center" });

  // Meta
  const today = new Date();
  const invoiceDate = today.toLocaleDateString("en-GB");
  const invoiceId = `INV-${today.getFullYear()}${String(today.getMonth()+1).padStart(2,"0")}${String(today.getDate()).padStart(2,"0")}`;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);
  doc.setTextColor(0);
  doc.text(`Invoice ID: ${invoiceId}`, pageWidth - 60, 120, { align: "right" });
  doc.text(`Date: ${invoiceDate}`, 60, 120, { align: "left" });

  // Table
  doc.autoTable({
    head: [["#", "Category", "Item", "Quantity", "Notes"]],
    body: sortedItems.map((it, i) => [
      i + 1,
      String(it.category || ""),
      String(it.name || ""),
      String(it.qty || ""),
      String(it.note || "")
    ]),
    startY: 160,
    theme: "grid",
    styles: { halign: "center", font: "helvetica", fontSize: 11 },
    headStyles: { fillColor: [40, 90, 160], textColor: [255, 255, 255], fontStyle: "bold" },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    margin: { left: 50, right: 50 },
    didDrawPage: () => {
      doc.setDrawColor(80, 80, 80);
      doc.setLineWidth(1.5);
      doc.rect(30, 30, pageWidth - 60, pageHeight - 60, "S");
      const pageCount   = doc.internal.getNumberOfPages();
      const pageCurrent = doc.internal.getCurrentPageInfo().pageNumber;
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Page ${pageCurrent} of ${pageCount}`, pageWidth / 2, pageHeight - 20, { align: "center" });
    }
  });

  // ⬅️ حفظ PDF فقط (الطريقة القديمة)
  doc.save(`Invoice_${invoiceId}.pdf`);
  showToast("تم تصدير PDF فقط ✅");
}





async function exportExcelOnly(){
  if(!currentInvoice || !(currentInvoice.items||[]).length){
    showToast("لا توجد بيانات للتصدير ❌", true);
    return;
  }

  // اسم الملف مثل الفاتورة
  const d = new Date();
  const invoiceId = `INV-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
  const xlsxName  = `Invoice_${invoiceId}.xlsx`;

  // ترتيب مثل PDF (Category ثم Item)
  const sorted = [...(currentInvoice.items||[])].sort((a,b)=>{
    const c = String(a.category||"").localeCompare(String(b.category||""), "en", {sensitivity:"base"});
    return c!==0 ? c : String(a.name||"").localeCompare(String(b.name||""), "en", {sensitivity:"base"});
  });

  // صفوف الإكسل (هيدر + بيانات)
  const rows = [
    ["Category","Item","Quantity","Notes"],
    ...sorted.map(it=>[
      String(it.category||""),
      String(it.name||""),
      String(it.qty||""),
      String(it.note||""),
    ])
  ];

  // إنشاء ملف Excel عبر SheetJS وحفظ مباشر (نفس فكرة doc.save للـ PDF)
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Invoice");

  XLSX.writeFile(wb, xlsxName, { compression: true }); // ⬅️ حفظ مباشر
  showToast("تم تصدير Excel ✅");
}


// تحميل Blob يشتغل على موبايل/ويب فيو/ديسكتوب
function downloadBlobFallback(filename, blob){
  // 1) Web Share API (أفضل شي للموبايل إن كان مدعوم)
  try{
    const file = new File([blob], filename, { type: blob.type || "application/octet-stream" });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      navigator.share({ files: [file], title: filename }).catch(()=>{});
      return;
    }
  }catch(_e){ /* نتجاهل ونكمّل */ }

  // 2) Edge القديم
  if (window.navigator && window.navigator.msSaveOrOpenBlob){
    window.navigator.msSaveOrOpenBlob(blob, filename);
    return;
  }

  // 3) رابط تنزيل + fallback فتح في تبويب (للوِب فيو اللي يتجاهل download)
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();

  // بعض الويب فيو ما ينزل بالرابط؛ جرّب نفتح التبويب
  setTimeout(()=>{
    // محاولة فتح في تبويب جديد
    const win = window.open(url, "_blank");
    if(!win){
      // آخر حل: تحويل نفس الصفحة
      window.location.href = url;
    }
    // تنظيف
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
  }, 250);
}

  
  
  
    /* =========================
       Toast بسيط
       ========================= */
    function showToast(message, isError){
      const toast = document.getElementById("appToast");
      toast.querySelector("span").textContent = message || "Done";
      toast.style.borderColor = isError ? "rgba(239,68,68,.6)" : "var(--stroke)";
      toast.firstElementChild.style.color = isError ? "#ef4444" : "#34d399";
      toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> toast.classList.remove("show"), 2200);
    }

    /* =========================
       ربط أزرار الهيدر والزر العائم
       ========================= */
       
 
document.getElementById("btnExportJSON").addEventListener("click", exportExcelOnly);
    document.getElementById("btnNew").addEventListener("click", newInvoice);
   document.getElementById("btnReload").addEventListener("click", reloadPage);
    document.getElementById("fab").addEventListener("click", newInvoice);
    document.getElementById("btnExportCSV")?.addEventListener("click", exportCSVOnly);

    
    
    
    
    
    // ✅ ربط زر الاستيراد لفتح مُلتقط الملفات
document.getElementById("btnImportPDF").addEventListener("click", ()=>{
  const picker = document.getElementById("pdfFilePicker");
  picker.value = "";           // ننظّف القيمة حتى يسمح باختيار نفس الملف مرة ثانية
  picker.click();              // نفتح نافذة اختيار الملفات
});
    
    
    
    
        // ===== PDF Imported Sidebar: Import & Merge =====
    // فتح مُلتقط PDF
  document.getElementById("pdfFilePicker").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  // نقبل XLSX أو CSV
  const ok = files.filter(f => {
    const name = f.name.toLowerCase();
    const type = (f.type || "").toLowerCase();
    return name.endsWith(".xlsx") ||
           name.endsWith(".csv")  ||
           type.includes("spreadsheet") ||
           type.includes("csv");
  });

  if(!ok.length){
    showToast("الملفات لازم تكون Excel أو CSV ❌", true);
    e.target.value = "";
    return;
  }

  // نخزّنها بالقائمة حتى تبين بالـ sidebar (نستخدم نفس المصفوفة الموجودة)
  importedPdfFiles.push(...ok);
  renderImportedPdfList();
  e.target.value = "";
  showToast("تم استيراد الملفات ✅");
});


    // الدمج + محاولة ترتيب الأيتمات أبجدياً
 document.getElementById("btnMergePDF").addEventListener("click", async ()=>{
  if(importedPdfFiles.length < 2){
    showToast("يرجى استيراد ملفين على الأقل (Excel/CSV) ❌", true);
    return;
  }

  try{
    // نقرأ كل الملفات بالتوازي
    const arrays = await Promise.all(importedPdfFiles.map(extractItemsFromFile));
    // ندمج كل النتائج بآري وحد
    let items = arrays.flat();

    // نتأكد أكو آيتمات
    items = items.filter(it => (it.item||"").trim().length);
    if(!items.length){
      showToast("ماكو عناصر صالحة بالملفات المستوردة ❌", true);
      return;
    }

    // ترتيب + وسم المكرر (عندك الدوال جاهزة)
    const nicelySorted = sortAndFlagDuplicates(items);

    // نولّد PDF مرتب (عندك buildItemsPdf)
    const doc = await buildItemsPdf(nicelySorted);

    // ⚠️ حتى الموبايل ما يخرّب الملف، نستخدم Blob بدل save()
    const blob = doc.output("blob");
    downloadBlobFallback(autoMergedName("ASSAL_SORTED"), blob);

    showToast("تم توليد PDF مدمج ومرتّب ✅");
  } catch(err){
    console.error(err);
    showToast("فشل الدمج ❌", true);
  }
});


    /* =========================
       منطق قائمة الأصناف المخصصة
       ========================= */
    const catBtn  = document.getElementById('catBtn');
    const catList = document.getElementById('catList');
    const catText = document.getElementById('catText');

    catBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const visible = catList.style.display==='block';
      document.querySelectorAll('.cat-list').forEach(el=> el.style.display='none');
      catList.style.display = visible ? 'none' : 'block';
    });

   document.querySelectorAll('.cat-item').forEach(it=>{
  it.addEventListener('click', ()=>{
    const val = it.getAttribute('data-val');
    document.getElementById('categorySelect').value = val;              // نحدّث قيمة الصنف (القديم)
    catText.innerHTML = it.innerHTML;                                   // نحدّث نص زر القائمة
    catList.style.display='none';
    showToast('تم اختيار الصنف ✅');
    document.getElementById("searchInput").focus(); // ينقلك مباشرة لاسم القطعة
  });
});

    // إغلاق القائمة بالنقر خارجها
    document.addEventListener('click', ()=> { catList.style.display='none'; });

    /* =========================
       تشغيل أولي عند تحميل الصفحة
       ========================= */
       window.addEventListener("load", ()=>{
      loadExcelFiles();
      renderInvoicesDropdown();
      renderImportedPdfList(); // ← يعرض قائمة PDF المستوردة 
       setTimeout(()=> showToast("👋 أهلاً وسهلاً بك في تطبيقنا"), 300);
    });

    
    
     // ربط Enter بالتنقل بين الحقول
  document.getElementById("searchInput").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault(); // يمنع إدخال سطر جديد
      document.getElementById("itemQty").focus(); // ينقلك لحقل العدد
    }
  });

  document.getElementById("itemQty").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      document.getElementById("itemNote").focus(); // ينقلك لحقل الملاحظات
    }
  });
    
    
  document.getElementById("itemNote").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault(); 

    if (!currentInvoice) {
      showToast("⚠️ أنشئ فاتورة جديدة أولاً", "danger");
      return;
    }

    addItem(); 
    autoSaveInvoice(); // ⬅️ يخزن الفاتورة تلقائي بعد الإضافة
    showToast("✅ تمت إضافة المادة وحفظ الفاتورة", "success");
    document.getElementById("searchInput").focus();
  }
});






    // ===== أدوات الدمج والفرز وبناء PDF مرتب =====

    // اسم تلقائي للملف الناتج
    function autoMergedName(prefix="ASSAL_MERGED"){
      const d = new Date();
      const y = d.getFullYear();
      const mo = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${prefix}_${y}${mo}${da}_${hh}${mm}.pdf`;
    }

    // تنزيل Bytes كـ PDF
    function downloadBytes(bytes, filename){
      const blob = new Blob([bytes], {type:"application/pdf"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }
    
    
  





    // ترتيب أبجدي (item ثم category) + وسم المكرر
    function sortAndFlagDuplicates(items){
  // 1) ترتيب مثل exportPDF: أولاً category ثم item (حساسّية بسيطة/بدون حالة أحرف)
  items.sort((a,b)=>{
    const catA = String(a.category || "");
    const catB = String(b.category || "");
    const itemA = String(a.item || "");
    const itemB = String(b.item || "");
    const catCompare = catA.localeCompare(catB, "en", { sensitivity: "base" });
    return catCompare !== 0 ? catCompare : itemA.localeCompare(itemB, "en", { sensitivity: "base" });
  });

  // 2) وسم العناصر المكرّرة (نفس الصنف + نفس القطعة) لتظليلها بالأحمر الخفيف في PDF
  const map = new Map();
  const out = items.map(it => ({...it, __dup:false}));
  out.forEach((it, idx)=>{
    const key = `${(it.category||"").toLowerCase()}||${(it.item||"").toLowerCase()}`;
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(idx);
  });
  for(const arr of map.values()){
    if(arr.length > 1) arr.forEach(i => out[i].__dup = true);
  }

  return out;
}

    // توليد PDF جديد بجدول مرتب + تظليل مكرر (jsPDF + autoTable)
    async function buildItemsPdf(sortedItems){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"pt", format:"a4" });
      const pageWidth  = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      // Header
      doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(25,25,112);
      doc.text("ASSAL OFFICE", pageWidth/2, 65, { align:"center" });
      doc.setFontSize(12); doc.setTextColor(100);
      doc.text("YOUR BEST CHOICE", pageWidth/2, 85, { align:"center" });

      // Meta
      const today = new Date();
      const invoiceDate = today.toLocaleDateString("en-GB");
      const invoiceId = `MERGE-${today.getFullYear()}${String(today.getMonth()+1).padStart(2,"0")}${String(today.getDate()).padStart(2,"0")}`;
      doc.setFont("helvetica","normal"); doc.setFontSize(12); doc.setTextColor(0);
      doc.text(`Merge ID: ${invoiceId}`, pageWidth - 60, 120, { align:"right" });
      doc.text(`Date: ${invoiceDate}`, 60, 120, { align:"left" });

      // جدول
      doc.autoTable({
        head: [["#", "Category", "Item", "Quantity", "Notes"]],
        body: sortedItems.map((it, i)=>[
          i+1,
          String(it.category||""),
          String(it.item||""),
          String(it.qty||""),
          String(it.note||"")
        ]),
        startY: 160,
        theme: "grid",
        styles: { halign:"center", font:"helvetica", fontSize:11 },
        headStyles: { fillColor:[40,90,160], textColor:[255,255,255], fontStyle:"bold" },
        alternateRowStyles: { fillColor:[245,245,245] },
        margin: { left:50, right:50 },

        didParseCell: function(data){
          if(data.section==='body'){
            const r = data.row.index;
            if(sortedItems[r].__dup){
              data.cell.styles.fillColor = [255,230,230]; // أحمر خفيف للمكرر
            }
          }
        },

        didDrawPage: ()=>{
          doc.setDrawColor(80,80,80); doc.setLineWidth(1.5);
          doc.rect(30, 30, pageWidth-60, pageHeight-60, "S");
          const pageCount   = doc.internal.getNumberOfPages();
          const pageCurrent = doc.internal.getCurrentPageInfo().pageNumber;
          doc.setFontSize(10); doc.setTextColor(100);
          doc.text(`Page ${pageCurrent} of ${pageCount}`, pageWidth/2, pageHeight-20, {align:"center"});
        }
      });

     return doc; // نرجّع كائن jsPDF نفسه


    }
    
    
    
    
    /* ===== Maintenance Mode ===== */
// غيّرها إلى true لما تريد تظهر نافذة الصيانة
const MAINTENANCE_MODE = false;

/**
 * إظهار/إخفاء نافذة الصيانة
 * يوقف تمرير الصفحة ويتجاهل كل التفاعلات بالخلفية
 */
function toggleMaintenance(show){
  const ov = document.getElementById('maintenanceOverlay');
  if(!ov) return;
  ov.style.display = show ? 'flex' : 'none';
  // قفل/فتح سكرول الصفحة
  document.documentElement.style.overflow = show ? 'hidden' : '';
  document.body.style.overflow = show ? 'hidden' : '';
}

/* تفعيل عبر باراميتر الرابط (اختياري): ?maintenance=1 */
function getQueryFlag(name){
  return new URLSearchParams(location.search).get(name);
}

/* فعّل الوضع عند تحميل الصفحة إذا الفلاغ يطلب ذلك */
window.addEventListener('load', ()=>{
  const viaQuery = getQueryFlag('maintenance') === '1';
  toggleMaintenance( MAINTENANCE_MODE || viaQuery );
});

    
    
    
    
    
    


    
  </script>
  
  
  <!-- ====== Footer ====== -->
  <footer class="app-footer">
    <div class="foot-wrap">
      <span>جميع الحقوق محفوظة © مكتب عسل 2025</span>
    </div>
  </footer>
  
  
  
</body>
</html>

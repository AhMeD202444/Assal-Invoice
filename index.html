<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ASSAL OFFICE • Invoices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- أيقونات -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- خطوط (Cairo للعربي + Poppins للإنكليزي) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- XLSX + jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
  
  
  
  /* نافذة منبثقة */
#reloadModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

/* محتوى النافذة */
.reload-box {
  background: #141821;
  padding: 24px;
  border-radius: 16px;
  text-align: center;
  color: #fff;
  min-width: 220px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}

/* دائرة تحميل */
.loader {
  border: 4px solid rgba(255,255,255,.2);
  border-top: 4px solid #21d4fd;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 0 auto 12px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

  
  
  
  
    :root{
  --bg-1:#0e0f13;
  --bg-2:#0a0b0e;
  --glass: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.14);
  --text:#f5f7ff;
  --muted:#aab0c0;
  --brand-1:#6d5efc;
  --brand-2:#21d4fd;
  --good:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 18px;
  --blur: 14px;
  --speed: .32s;
}

*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: "Cairo","Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
  color: var(--text);
  background:
    radial-gradient(1200px 1200px at 120% -20%, rgba(33,212,253,.20), transparent 60%),
    radial-gradient(900px 900px at -10% 120%, rgba(109,94,252,.20), transparent 60%),
    linear-gradient(180deg, var(--bg-1), var(--bg-2));
  overflow-x:hidden;
}

/* ====== Header ====== */
.app-header{
  position:sticky; top:0; z-index:50;
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  background: linear-gradient( to bottom, rgba(10,11,14,.75), rgba(10,11,14,.35) );
  border-bottom: 1px solid var(--stroke);
}
.head-wrap{
  max-width:1200px; margin:auto; padding:14px 18px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.brand{
  display:flex; align-items:center; gap:12px;
  font-weight:700; letter-spacing:.3px;
}
.brand .badge{
  width:40px; height:40px; display:grid; place-items:center;
  background: radial-gradient(120% 120% at 20% 20%, var(--brand-2), var(--brand-1));
  border-radius:12px; color:#0b0d13; font-weight:900;
  box-shadow: var(--shadow);
}
.brand small{ color: var(--muted); font-weight:600; display:block; margin-top:-2px; font-size:12px; }
.head-actions{ display:flex; align-items:center; gap:10px; }
.icon-btn{
  width:40px; height:40px; display:grid; place-items:center;
  border:1px solid var(--stroke);
  background: var(--glass);
  border-radius:12px; color:var(--text);
  cursor:pointer; transition: transform var(--speed), background var(--speed), border-color var(--speed);
}
.icon-btn:hover{ transform: translateY(-2px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.25); }

/* ====== Layout ====== */
.layout{
  max-width:1200px; margin:22px auto; padding:0 16px;
  display:grid; grid-template-columns: 280px 1fr; gap:16px;
}

/* تابلت */
@media (max-width: 992px){
  .layout{ grid-template-columns: 1fr; }
}

/* موبايل */
@media (max-width: 576px){
  .layout{
    grid-template-columns: 1fr;
    padding:0 10px;
    margin:14px auto;
  }
  .sidebar {
    order: 2; /* السايدبار ينزل جوة */
  }
  .content {
    order: 1; /* المحتوى يطلع فوق */
  }
}


/* ====== Sidebar ====== */
.sidebar{
  background: var(--glass);
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:14px;
  position:relative;
  overflow:hidden;
}
.panel-title{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:8px 6px 12px; border-bottom:1px dashed var(--stroke);
  margin-bottom:10px;
}
.panel-title h3{ margin:0; font-size:16px; font-weight:800; letter-spacing:.2px; }
.pill{
  background: rgba(255,255,255,.08);
  border:1px solid var(--stroke);
  padding:6px 10px; border-radius:999px; color: var(--muted); font-size:12px;
}

/* Category select */
.category{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.cat-label{ font-size:12px; color:var(--muted); padding:0 6px; }
.cat-select{ position:relative; user-select:none; }
.cat-btn{
  width:100%;
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:12px 14px; cursor:pointer;
  transition: background var(--speed), border-color var(--speed), transform var(--speed);
}
.cat-btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.25); transform: translateY(-1px); }
.cat-list{
  position:absolute; inset-inline:0; top: calc(100% + 8px); z-index:5;
  background: rgba(16,18,24,.98);
  border:1px solid var(--stroke);
  border-radius:16px;
  box-shadow: var(--shadow);
  padding:6px;
  display:none;
  max-height: 280px; overflow:auto;
}
.cat-item{
  padding:10px 12px; border-radius:10px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  color:var(--text); font-weight:600;
  transition: background var(--speed), transform var(--speed);
  border-bottom: 1px dashed rgba(255,255,255,.08);
  text-align:center;
}
.cat-item:last-child{ border-bottom:none; }
.cat-item:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
.cat-item i{ color: var(--brand-2); }

/* Invoices list */
.invoices-list{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
.invoice-chip{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  background: rgba(255,255,255,.05);
  border:1px solid var(--stroke);
  padding:10px 12px; border-radius:12px; cursor:pointer;
  transition: background var(--speed), transform var(--speed);
}
.invoice-chip:hover{ background: rgba(255,255,255,.09); transform: translateY(-1px); }
.chip-meta{ display:flex; flex-direction:column; gap:4px; }
.chip-meta strong{ font-size:13px; }
.chip-meta small{ color:var(--muted); }

/* ====== Content ====== */
.content{ display:flex; flex-direction:column; gap:18px; }

/* Grid cards */
.grid{
  display:grid; grid-template-columns: repeat(3,1fr); gap:14px;
}
@media (max-width: 992px){
  .grid{ grid-template-columns: repeat(2,1fr); }
}
@media (max-width: 576px){
  .editor .ginput {
    flex: 1 1 100%;
  }
  .editor > div {
    flex-direction: column;
  }
  .gfield, .btn {
    font-size:14px;
    padding:10px 12px;
  }
}

.card{
  background: var(--glass);
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:16px;
  overflow:hidden;
  position:relative;
}
.card .title{ display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px; margin-bottom:8px; }
.value{ font-weight:900; font-size:22px; letter-spacing:.3px; display:flex; align-items:center; gap:8px; }
.trend{ font-size:12px; color: var(--good); }

/* Editor */
.editor{ display: flex; flex-direction: column; gap: 12px; }
#searchInput { width: 100%; }
.card.table-wrap { margin-top: 20px; }

/* Footer */
.app-footer {
  position: sticky; bottom: 0; z-index: 50;
  backdrop-filter: blur(var(--blur));
  -webkit-backdrop-filter: blur(var(--blur));
  background: linear-gradient(to top, rgba(10,11,14,.85), rgba(10,11,14,.35));
  border-top: 1px solid var(--stroke);
}
.foot-wrap {
  max-width: 1200px;
  margin: auto;
  padding: 12px 18px;
  text-align: center;
  font-size: 13px;
  color: var(--muted);
}

/* Inputs and buttons */
.ginput{ display:flex; flex-direction:column; gap:8px; }
.glabel{ font-size:12px; color:var(--muted); padding:0 6px; }
.gfield{
  background: rgba(255,255,255,.06);
  border:1px solid var(--stroke);
  padding:12px 14px; border-radius:14px; color: var(--text);
  outline:none; transition: border-color var(--speed), background var(--speed), transform var(--speed);
  text-align:center;
  width:100%; max-width:100%;
}
.gfield::placeholder{ color: #93a0b8; }
.gfield:focus{ border-color: rgba(255,255,255,.35); background: rgba(255,255,255,.09); transform: translateY(-1px); }

.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:12px 14px; border:none; cursor:pointer; font-weight:800; letter-spacing:.3px;
  border-radius:14px; color:#0b0d13;
  background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
  box-shadow: 0 8px 20px rgba(109,94,252,.35);
  transition: transform var(--speed), box-shadow var(--speed), filter var(--speed);
  width:100%; max-width:100%;
}
.btn:hover{ transform: translateY(-2px); filter: brightness(1.05); box-shadow: 0 10px 26px rgba(109,94,252,.45); }
.btn.green{ background:linear-gradient(135deg,#34d399,#10b981); color:#091018; }
.btn.amber{ background:linear-gradient(135deg,#f59e0b,#d97706); color:#0b0d13; }
.btn.blue{ background:linear-gradient(135deg,#60a5fa,#2563eb); color:#0b0d13; }

/* Table */
.table-wrap{ padding:0; overflow-x:auto; border-radius:14px; }
table{
  width:100%;
  min-width:100%;
  border-collapse: collapse;
  background: rgba(255,255,255,.04);
  border:1px solid var(--stroke);
  border-radius:14px;
  overflow:hidden;
}

thead th{
  background: linear-gradient(90deg, rgba(33,212,253,.18), rgba(109,94,252,.18));
  color:#dfe6ff;
  padding:14px;
  font-weight:800;
  border-bottom:1px solid var(--stroke);
  text-align:center;
}
tbody td{
  padding:14px; text-align:center; border-bottom:1px dashed rgba(255,255,255,.08);
  color:#eaf0ff;
}
tbody tr:last-child td{ border-bottom:none; }
.btn-danger-custom{
  width:36px; height:36px; display:grid; place-items:center; border-radius:10px; color:#fff;
  background: rgba(255,255,255,.08); border:1px solid var(--stroke); cursor:pointer;
  transition: transform var(--speed), background var(--speed);
}
.btn-danger-custom:hover{ background: rgba(255,255,255,.14); transform: translateY(-2px); color:#fff; }

/* Floating button */
.fab{
  position:fixed; inset-inline-start:20px; inset-block-end:20px; z-index:60;
  width:58px; height:58px; display:grid; place-items:center; border-radius:50%;
  background: conic-gradient(from 180deg at 50% 50%, var(--brand-2), var(--brand-1), var(--brand-2));
  color:#0b0d13; font-size:20px; font-weight:900;
  box-shadow: 0 14px 35px rgba(100,95,255,.45);
  cursor:pointer; transition: transform var(--speed);
}
.fab:hover{ transform: translateY(-3px) rotate(-2deg); }

/* Toast */
.toast-container{ position: fixed; inset-block-start:18px; inset-inline:0; display:grid; place-items:center; z-index:70; }
.toast{
  background: rgba(20,24,33,.96);
  border: 1px solid var(--stroke);
  color: var(--text);
  padding:12px 16px; border-radius:12px; box-shadow: var(--shadow);
  display:none; align-items:center; gap:10px; font-weight:700;
}
.toast.show{ display:flex; animation: pop .3s ease; }
@keyframes pop{ from{ transform: translateY(-8px); opacity:.0; } to{ transform: translateY(0); opacity:1; } }

/* Search suggestions */
#autocompleteSuggestions{
  position: absolute; inset-inline:0; inset-block-start:100%; margin-block-start:6px;
  background: rgba(16,18,24,.98);
  border:1px solid var(--stroke);
  border-radius:14px;
  max-height:240px; overflow:auto; z-index:40; display:none;
}
#autocompleteSuggestions li{
  list-style:none; padding:10px 12px; cursor:pointer; text-align:center; color:#eaf0ff;
  border-bottom:1px dashed rgba(255,255,255,.08);
}
#autocompleteSuggestions li:last-child{ border-bottom:none; }
#autocompleteSuggestions li:hover{ background: rgba(255,255,255,.06); }

/* Responsive header + footer for small screens */
@media (max-width:576px){
  .brand .badge{ width:32px; height:32px; font-size:14px; }
  .head-actions .icon-btn{ width:34px; height:34px; }
  .head-wrap, .foot-wrap{ padding:10px 12px; }
}

  </style>
</head>
<body>
  
  
  
  
  <!-- نافذة منبثقة للتحديث -->
<div id="reloadModal">
  <div class="reload-box">
    <div class="loader"></div>
    <p id="reloadText">جاري التحديث...</p>
  </div>
</div>

  
  
  

  <!-- ====== Header ====== -->
  <header class="app-header">
    <div class="head-wrap">
      <div class="brand">
        <div class="badge">A</div>
        <div>
          ASSAL OFFICE
          <small>YOUR BEST CHOICE</small>
        </div>
      </div>

      <div class="head-actions">
        <button class="icon-btn" id="btnNew" title="فاتورة جديدة"><i class="fa-solid fa-plus"></i></button>
      <!-- زر تحديث -->
<button class="icon-btn" id="btnReload" title="تحديث الصفحة">
  <i class="fa-solid fa-rotate-right"></i>
</button>

      </div>
    </div>
  </header>

  <!-- ====== Layout ====== -->
  <main class="layout">

    <!-- ====== Sidebar ====== -->
    <aside class="sidebar" id="sidebar">
      <div class="panel-title">
        <h3><i class="fa-regular fa-folder-open"></i> الفواتير السابقة</h3>
        <span class="pill">اليوم</span>
      </div>

    

      <!-- لائحة الفواتير السابقة (نفس الـ id القديم لكن داخل الشريط) -->
      <div class="invoices-list" id="invoicesDropdown"></div>
    </aside>

    <!-- ====== Content ====== -->
    <section class="content">


      <!-- بطاقة معلومات الفاتورة الحالية -->
      <div class="card" style="display:flex; align-items:center; gap:12px;">
        <i class="fa-regular fa-file-lines" style="font-size:28px; color:#21d4fd;"></i>
        <div>
          <div style="font-weight:800; letter-spacing:.2px;">فاتورة حالية</div>
          <div style="color:var(--muted); font-size:12px;">رقم الفاتورة: <span id="invoiceId">-</span></div>
        </div>
      </div>

      <!-- محرر الفاتورة -->
      <div class="card">
        <div class="title"><span><i class="fa-solid fa-pen-to-square"></i> إضافة مادة</span><span class="muted">Editor</span></div>

       <div class="editor">

  <!-- الصنف -->
  <div class="category">
    <!-- زر فتح القائمة -->
    <div class="cat-select" id="catSelect">
      <div class="cat-btn" id="catBtn">
        <span id="catText"><i class="fa-solid fa-layer-group"></i> اختر الصنف</span>
        <i class="fa-solid fa-chevron-down"></i>
      </div>

      <!-- قائمة الأصناف -->
      <div class="cat-list" id="catList">
        <div class="cat-item" data-val="LCD"><i class="fa-solid fa-tv"></i> شاشات</div>
        <div class="cat-item" data-val="BATTERY"><i class="fa-solid fa-bolt"></i> بطاريات</div>
        <div class="cat-item" data-val="CAMERA"><i class="fa-solid fa-camera"></i> كاميرات</div>
        <div class="cat-item" data-val="CHARGING"><i class="fa-solid fa-plug"></i> شحن</div>
        <div class="cat-item" data-val="HEADPHONE"><i class="fa-solid fa-headphones"></i> سماعة</div>
        <div class="cat-item" data-val="HOUSING"><i class="fa-solid fa-border-none"></i> شواصي</div>
        <div class="cat-item" data-val="BACK"><i class="fa-solid fa-mobile-screen"></i> أظهر</div>
        <div class="cat-item" data-val="BUZZER"><i class="fa-solid fa-bell"></i> جرس</div>
        <div class="cat-item" data-val="FINGER"><i class="fa-solid fa-fingerprint"></i> بصمة</div>
        <div class="cat-item" data-val="NO-CATEGORY"><i class="fa-regular fa-square"></i> بدون صنف</div>
      </div>
    </div>

    <!-- الحقل المخفي -->
    <input id="categorySelect" type="hidden" />
  </div>

  <!-- اسم القطعة -->
  <div class="ginput">
    <div style="position:relative;">
      <input id="searchInput" class="gfield" type="text" placeholder="اكتب اسم القطعة..." oninput="showSuggestions()" />
      <ul id="autocompleteSuggestions"></ul>
    </div>
  </div>

  <!-- العدد + الملاحظات بنفس الصف -->
  <div style="display:flex; gap:12px;">
    <div class="ginput" style="flex:1;">
      <input id="itemQty" class="gfield" type="text" placeholder="عدد القطع" />
    </div>
    <div class="ginput" style="flex:1;">
      <input id="itemNote" class="gfield" type="text" placeholder="ملاحظات" />
    </div>
  </div>

  <!-- أزرار -->
  <div class="ginput" style="display:flex; gap:10px;">
    <button class="btn" onclick="addItem()"><i class="fa-solid fa-plus"></i> إضافة</button>
    <button class="btn green" onclick="saveInvoice()"><i class="fa-regular fa-floppy-disk"></i> حفظ</button>
    <button class="btn blue" onclick="exportPDF()"><i class="fa-regular fa-file-pdf"></i> PDF</button>
  </div>
</div>
      <!-- الجدول -->
      <div class="card table-wrap">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>الصنف</th>
              <th>القطعة</th>
              <th>العدد</th>
              <th>ملاحظات</th>
              <th>إزالة</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </section>
  </main>

  <!-- زر عائم = فاتورة جديدة -->
  <button class="fab" id="fab" title="فاتورة جديدة">
    <i class="fa-solid fa-plus"></i>
  </button>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast" id="appToast">
      <i class="fa-solid fa-circle-check" style="color:#34d399;"></i>
      <span>تمت العملية بنجاح.</span>
    </div>
  </div>

  <script>
    /* =========================
       متغيرات عامة (نفس القديمة)
       ========================= */
    let currentInvoice = null;                                             // الفاتورة الحالية
    let invoices = JSON.parse(localStorage.getItem("invoices") || "[]");   // كل الفواتير المخزنة
    let selectedInvoiceIndex = null;                                       // مؤشر الفاتورة المختارة
    let database = {};                                                     // قاعدة بيانات الأصناف من الإكسل
    let currentCategory = "";                                              // الصنف الحالي المختار

    // رابط ملف الإكسل (نفسك)
    const dropboxMainFile = "https://assap-app-project.ahmed-al-bayatii-90.workers.dev/file1?t=" + new Date().getTime();






function reloadPage(){
  const modal = document.getElementById("reloadModal");
  const text  = document.getElementById("reloadText");

  // إظهار النافذة
  modal.style.display = "flex";
  text.textContent = "جاري التحديث...";

  // بعد ثانيتين نغير النص
  setTimeout(()=>{
    text.textContent = "تم التحديث ✅";
  }, 2000);

  // بعد 3 ثواني نعيد تحميل الصفحة فعلياً
  setTimeout(()=>{
    window.location.reload();
  }, 3000);
}






    /* =========================
       تحميل جداول الإكسل
       ========================= */
    async function loadExcelFiles(){
      try{
        const response = await fetch(dropboxMainFile, { cache: 'no-store' });
        const buffer = await response.arrayBuffer();
        const workbook = XLSX.read(buffer, { type:"array" });
        database = {
          LCD      : XLSX.utils.sheet_to_json(workbook.Sheets["LCD"]      || {}, {defval:null}),
          BATTERY  : XLSX.utils.sheet_to_json(workbook.Sheets["BATTERY"]  || {}, {defval:null}),
          HOUSING  : XLSX.utils.sheet_to_json(workbook.Sheets["HOUSING"]  || {}, {defval:null}),
          BACK     : XLSX.utils.sheet_to_json(workbook.Sheets["BACK"]     || {}, {defval:null}),
          CAMERA   : XLSX.utils.sheet_to_json(workbook.Sheets["CAMERA"]   || {}, {defval:null}),
          CHARGING : XLSX.utils.sheet_to_json(workbook.Sheets["CHARGING"] || {}, {defval:null}),
          BUZZER   : XLSX.utils.sheet_to_json(workbook.Sheets["BUZZER"]   || {}, {defval:null}),
          HEADPHONE: XLSX.utils.sheet_to_json(workbook.Sheets["HEADPHONE"]|| {}, {defval:null}),
          FINGER   : XLSX.utils.sheet_to_json(workbook.Sheets["FINGER"]   || {}, {defval:null})
        };
      }catch(err){
        console.error("❌ خطأ تحميل:", err);
        showToast("تعذر تحميل البيانات ❌", true);
      }
    }

    /* =========================
       أدوات مساعدة
       ========================= */
    function normalizeString(str){ return (str||"").replace(/\s+/g,'').toLowerCase(); }

    function getDayNameAr(d){
      return ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][d.getDay()];
    }

    function formatInvoiceName(){
      const d = new Date();
      return `فاتورة ${getDayNameAr(d)} - ${d.toLocaleDateString("ar-EG")}`;
    }

    /* =========================
       اقتراحات البحث حسب الصنف
       ========================= */
    function showSuggestions(){
      const q = normalizeString(document.getElementById("searchInput").value.trim());
      const suggestions = document.getElementById("autocompleteSuggestions");
      suggestions.innerHTML = "";
      suggestions.style.display = "none";

      const catVal = document.getElementById("categorySelect").value;
      if(!q || !catVal) return;

      // إذا بدون صنف -> ماكو اقتراحات
      if(catVal === "NO-CATEGORY") return;

      const list = database[catVal] || [];
      const filtered = list.filter(it=>{
        const name = normalizeString(it["Item Name"] || it["Item"] || "");
        return name.includes(q);
      }).slice(0, 10);

      if(filtered.length > 0){
        suggestions.style.display = "block";
        filtered.forEach(it=>{
          const li = document.createElement("li");
          li.textContent = it["Item Name"] || it["Item"];
          li.onclick = ()=>{
            document.getElementById("searchInput").value = li.textContent;
            suggestions.style.display = "none";
          };
          suggestions.appendChild(li);
        });
      }
    }

    /* =========================
       إضافة مادة للفاتورة
       ========================= */
    function addItem(){
      if(!currentInvoice){
        showToast("أنشئ فاتورة جديدة أولاً ❗", true);
        return;
      }
      const category = document.getElementById("categorySelect").value;
      const name = document.getElementById("searchInput").value.trim();
      const qty  = document.getElementById("itemQty").value.trim() || "1";
      const note = document.getElementById("itemNote").value.trim() || "";

      if(!category || !name){
        showToast("أدخل الصنف واسم القطعة ⚠️", true);
        return;
      }

      currentInvoice.items.push({ category, name, qty, note });
      renderItems();

      // تنظيف الحقول بعد الإضافة
      document.getElementById("searchInput").value = "";
      document.getElementById("itemQty").value = "";
      document.getElementById("itemNote").value = "";
    }

    /* =========================
       رسم جدول العناصر
       ========================= */
    function renderItems(){
      const tbody = document.querySelector("#itemsTable tbody");
      tbody.innerHTML = "";
      if(!currentInvoice) return;

      currentInvoice.items.forEach((it, i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.category}</td>
          <td>${it.name}</td>
          <td>${it.qty}</td>
          <td>${it.note}</td>
          <td>
            <button class="btn-danger-custom" onclick="removeItem(${i})" title="حذف">
              <i class="fa-regular fa-trash-can"></i>
            </button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function removeItem(i){
      currentInvoice.items.splice(i,1);
      renderItems();
    }

    /* =========================
       إنشاء / حفظ / فتح / حذف فواتير
       ========================= */
    function newInvoice(){
      const today = new Date().toLocaleDateString("ar-EG");
      const existingIndex = invoices.findIndex(inv => inv.date === today);

      if(existingIndex !== -1){
        currentInvoice = invoices[existingIndex];
        selectedInvoiceIndex = existingIndex;
        showToast("فاتورة اليوم موجودة، تم تحميلها ✅");
      } else {
        currentInvoice = { id: formatInvoiceName(), date: today, items: [] };
        invoices.push(currentInvoice);
        selectedInvoiceIndex = invoices.length - 1;
        showToast("تم إنشاء فاتورة جديدة ✅");
      }

      document.getElementById("invoiceId").textContent = currentInvoice.id;
      renderItems();
      renderInvoicesDropdown();
    }

    function saveInvoice(){
      if(!currentInvoice) return;
      if(selectedInvoiceIndex !== null){
        invoices[selectedInvoiceIndex] = currentInvoice;
      } else {
        invoices.push(currentInvoice);
      }
      localStorage.setItem("invoices", JSON.stringify(invoices));
      renderInvoicesDropdown();
      showToast("تم حفظ الفاتورة 💾");
    }

    function renderInvoicesDropdown(){
      const wrap = document.getElementById("invoicesDropdown");
      wrap.innerHTML = "";
      invoices.forEach((inv, i)=>{
        const row = document.createElement("div");
        row.className = "invoice-chip";
        row.innerHTML = `
          <div class="chip-meta">
            <strong>${inv.id}</strong>
            <small>${inv.date} • ${inv.items.length} مادة</small>
          </div>
          <button class="btn-danger-custom" title="حذف" onclick="deleteInvoice(${i}); event.stopPropagation();">
            <i class="fa-regular fa-trash-can"></i>
          </button>
        `;
        row.onclick = ()=> loadInvoice(i);
        wrap.appendChild(row);
      });
    }

    function loadInvoice(i){
      selectedInvoiceIndex = i;
      currentInvoice = invoices[i];
      document.getElementById("invoiceId").textContent = currentInvoice.id;
      renderItems();
      showToast("تم تحميل الفاتورة 📄");
    }

    function deleteInvoice(i){
      invoices.splice(i,1);
      localStorage.setItem("invoices", JSON.stringify(invoices));
      currentInvoice = null;
      document.getElementById("invoiceId").textContent = "-";
      renderItems();
      selectedInvoiceIndex = null;
      renderInvoicesDropdown();
      showToast("تم حذف الفاتورة 🗑️");
    }

  

    /* =========================
       تصدير PDF بشكل أنيق بالإنكليزي
       ========================= */
    function exportPDF(){
      if (!currentInvoice || currentInvoice.items.length === 0) {
        showToast("No data to export ❌", true);
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

      // إطار أنيق
      doc.setDrawColor(80, 80, 80);
      doc.setLineWidth(1.5);
      doc.rect(30, 30, 540, 780, "S");

      // Header
      doc.setFont("helvetica", "bold");
      doc.setFontSize(22);
      doc.setTextColor(25, 25, 112);
      doc.text("ASSAL OFFICE", 300, 65, { align: "center" });

      doc.setFontSize(12);
      doc.setTextColor(100);
      doc.text("YOUR BEST CHOICE", 300, 85, { align: "center" });

      // معلومات الفاتورة (إنكليزي)
      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      doc.setTextColor(0);

      const today = new Date();
      const invoiceDate = today.toLocaleDateString("en-GB"); // تاريخ إنكليزي
      const invoiceId = `INV-${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,"0")}${today.getDate().toString().padStart(2,"0")}`;

      doc.text(`Invoice ID: ${invoiceId}`, 500, 120, { align: "right" });
      doc.text(`Date: ${invoiceDate}`, 60, 120, { align: "left" });

      // جدول
      doc.autoTable({
        head: [["Category", "Item", "Quantity", "Notes"]],
        body: (currentInvoice.items || []).map(it => [it.category, it.name, it.qty, it.note]),
        startY: 160,
        theme: "grid",
        styles: { halign: "center", font: "helvetica", fontSize: 11 },
        headStyles: { fillColor: [40, 90, 160], textColor: [255, 255, 255], fontStyle: "bold" },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 50, right: 50 }
      });

      // حفظ
      doc.save(`Invoice_${invoiceId}.pdf`);
      showToast("Invoice exported successfully 📄");
    }

    /* =========================
       Toast بسيط
       ========================= */
    function showToast(message, isError){
      const toast = document.getElementById("appToast");
      toast.querySelector("span").textContent = message || "Done";
      toast.style.borderColor = isError ? "rgba(239,68,68,.6)" : "var(--stroke)";
      toast.firstElementChild.style.color = isError ? "#ef4444" : "#34d399";
      toast.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> toast.classList.remove("show"), 2200);
    }

    /* =========================
       ربط أزرار الهيدر والزر العائم
       ========================= */
    document.getElementById("btnNew").addEventListener("click", newInvoice);
   document.getElementById("btnReload").addEventListener("click", reloadPage);
    document.getElementById("fab").addEventListener("click", newInvoice);

    /* =========================
       منطق قائمة الأصناف المخصصة
       ========================= */
    const catBtn  = document.getElementById('catBtn');
    const catList = document.getElementById('catList');
    const catText = document.getElementById('catText');

    catBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const visible = catList.style.display==='block';
      document.querySelectorAll('.cat-list').forEach(el=> el.style.display='none');
      catList.style.display = visible ? 'none' : 'block';
    });

    document.querySelectorAll('.cat-item').forEach(it=>{
      it.addEventListener('click', ()=>{
        const val = it.getAttribute('data-val');
        document.getElementById('categorySelect').value = val;              // نحدّث قيمة الصنف (القديم)
        catText.innerHTML = it.innerHTML;                                   // نحدّث نص زر القائمة
        catList.style.display='none';
        showToast('تم اختيار الصنف ✅');
      });
    });

    // إغلاق القائمة بالنقر خارجها
    document.addEventListener('click', ()=> { catList.style.display='none'; });

    /* =========================
       تشغيل أولي عند تحميل الصفحة
       ========================= */
    window.addEventListener("load", ()=>{
      loadExcelFiles();
      renderInvoicesDropdown();
    });
  </script>
  
  
  <!-- ====== Footer ====== -->
  <footer class="app-footer">
    <div class="foot-wrap">
      <span>جميع الحقوق محفوظة © مكتب عسل 2025</span>
    </div>
  </footer>
  
  
  
</body>
</html>
